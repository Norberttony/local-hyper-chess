{"version":3,"file":"engine-widget.js","sourceRoot":"","sources":["../../../graphics/widgets/engine-widget.ts"],"names":[],"mappings":"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","sourcesContent":["import { BoardWidget, WidgetLocation } from \"./board-widget.js\";\nimport { Board, Side } from \"../../index.js\";\nimport { WebBotProcess } from \"../../engine/web/web-bot-process.js\";\nimport type { BoardGraphics } from \"../board-graphics.js\";\nimport { UCIBotProtocol } from \"../../engine/protocols/uci-protocol.js\";\nimport { ThinkStats } from \"../../engine/utils.js\";\n\nexport class EngineWidget extends BoardWidget {\n    private engine: WebBotProcess = new WebBotProcess(\"./scripts/hyper-active/main.js\");\n    private protocol: UCIBotProtocol = new UCIBotProtocol(this.engine);\n\n    private container: HTMLElement;\n    private activeElem: HTMLInputElement;\n    private evalElem: HTMLElement;\n    private pvElem: HTMLElement;\n    private depthElem: HTMLElement;\n    private npsElem: HTMLElement;\n\n    constructor(boardgfx: BoardGraphics, location: WidgetLocation){\n        super(boardgfx);\n\n        const container = document.createElement(\"div\");\n        container.classList.add(\"board-graphics__engine\");\n        container.innerHTML = `\n            <input class = \"engine__active\" type = \"checkbox\">\n            <span class = \"engine__eval\">-</span>\n            <span class = \"engine__name\">Hyper Chess Engine</span>\n            depth\n            <span class = \"engine__depth\"></span>\n            (<span class = \"engine__nps\"></span>nps)\n            <div class = \"engine__pv\">-</div>`;\n        boardgfx.getWidgetContainer(location).appendChild(container);\n\n        this.container = container;\n\n        this.setName();\n\n        this.activeElem = this.container.getElementsByClassName(\"engine__active\")[0] as HTMLInputElement;\n        this.evalElem = this.container.getElementsByClassName(\"engine__eval\")[0] as HTMLElement;\n        this.pvElem = this.container.getElementsByClassName(\"engine__pv\")[0] as HTMLElement;\n        this.depthElem = this.container.getElementsByClassName(\"engine__depth\")[0] as HTMLElement;\n        this.npsElem = this.container.getElementsByClassName(\"engine__nps\")[0] as HTMLElement;\n\n        this.activeElem.addEventListener(\"change\", () => {\n            if (this.activeElem.checked)\n                this.start();\n            else\n                this.stop();\n        });\n\n        boardgfx.skeleton.addEventListener(\"variation-change\", (event) => {\n            this.startThinking();\n        });\n    }\n\n    public override enable(): void {\n        this.container.style.display = \"\";\n    }\n\n    public override disable(): void {\n        this.container.style.display = \"none\";\n        this.stop();\n    }\n\n    public start(): void {\n        this.activeElem.checked = true;\n        this.setName();\n        this.engine.start();\n\n        this.protocol.addThinkStatsUpdateListener((stats: ThinkStats) => {\n            // get eval\n            if (stats.score){\n                const isWTP = this.boardgfx.getTurn() == Side.White;\n                const score = (isWTP ? 1 : -1) * stats.score.value;\n                const sign = score > 0 ? \"+\" : \"\";\n\n                if (stats.score.isMate){\n                    this.evalElem.innerText = `#${sign}${(score < 0 ? -1 : 1) * Math.floor((Math.abs(score) + 1) / 2)}`;\n                }else{\n                    this.evalElem.innerText = `${sign}${(score / 100).toFixed(1)}`;\n                }\n            }\n\n            // get pv\n            if (stats.pv){\n                const pv = stats.pv.split(\" \");\n                const b = new Board(this.boardgfx.getFEN());\n                let fullmove = this.boardgfx.getFullMove();\n                let pvSan = this.boardgfx.getTurn() == Side.White ? \"\" : `${fullmove}... `;\n                for (const m of pv){\n                    const move = b.getMoveOfLAN(m);\n                    if (b.getTurn() == Side.White)\n                        pvSan += `${fullmove}. `\n                    else\n                        fullmove++;\n                    pvSan += b.getMoveSAN(move) + \" \";\n                    b.makeMove(move);\n                }\n\n                this.pvElem.innerText = pvSan;\n            }\n\n            // get depth\n            if (stats.depth)\n                this.depthElem.innerText = stats.depth.toString();\n\n            // get nps\n            if (stats.nodes && stats.time){\n                const nps = stats.nodes / (stats.time / 1000);\n\n                // prefixes determined by every one thousand\n                const prefixes = [ \"\", \"K\", \"M\", \"G\" ];\n                const prefixIdx = Math.floor(Math.log(nps) / Math.log(1000));\n                const nptime = (nps / Math.pow(1000, prefixIdx)).toPrecision(3);\n\n                this.npsElem.innerText = `${nptime} ${prefixes[prefixIdx]}`;\n            }\n        });\n        this.startThinking();\n    }\n\n    stop(){\n        this.activeElem.checked = false;\n\n        if (this.engine.isRunning)\n            this.engine.stop();\n    }\n\n    startThinking(){\n        if (this.engine.isRunning){\n            this.protocol.stopThink();\n            this.protocol.setFEN(this.boardgfx.getFEN());\n            this.protocol.startThink();\n        }\n    }\n\n    async setName(){\n        const nameElem = this.container.getElementsByClassName(\"engine__name\")[0] as HTMLElement;\n        if (await this.protocol.isReady(10000))\n            nameElem.innerText = this.protocol.getEngineName();\n    }\n}\n"]}