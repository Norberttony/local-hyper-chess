{"version":3,"file":"annotator-widget.js","sourceRoot":"","sources":["../../../graphics/widgets/annotator-widget.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BoardGraphics } from \"../board-graphics.js\";\nimport { BoardWidget } from \"./board-widget.js\";\n\ninterface Annotation {\n    startX: number,\n    startY: number,\n    endX: number,\n    endY: number\n};\n\nexport class AnnotatorWidget extends BoardWidget {\n    private annotations: Annotation[] = [];\n    private ctx: CanvasRenderingContext2D;\n\n    private startX?: number;\n    private startY?: number;\n\n    constructor(boardgfx: BoardGraphics){\n        super(boardgfx);\n\n        // initialize by adding canvas\n        const canvas = document.createElement(\"canvas\");\n        canvas.classList.add(\"board-graphics__annotations\");\n        boardgfx.boardDiv.appendChild(canvas);\n\n        canvas.width = 1000;\n        canvas.height = 1000;\n\n        // this currently creates a circular reference which could lead to memory leaks if boardgfx\n        // (instance of BoardGraphics) does not delete this .boardgfx reference.\n        this.ctx = canvas.getContext(\"2d\") as CanvasRenderingContext2D;\n        this.ctx.lineWidth = 12;\n        this.ctx.strokeStyle = \"rgba(0, 120, 0)\";\n        this.ctx.fillStyle = \"rgba(0, 120, 0)\";\n        this.ctx.lineCap = \"round\";\n\n        // attach event listeners\n        boardgfx.boardDiv.addEventListener(\"mousedown\", (event) => {\n            this.mousedown(event);\n        })\n        boardgfx.boardDiv.addEventListener(\"mouseup\", (event) => {\n            this.mouseup(event);\n        });\n        boardgfx.boardDiv.addEventListener(\"contextmenu\", (event) => {\n            event.preventDefault();\n        });\n        boardgfx.skeleton.addEventListener(\"variation-change\", () => {\n            this.clearAll();\n        });\n    }\n\n    private redrawAll(): void {\n        this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);\n        for (const a of this.annotations){\n            this.drawAnnotation(a);\n        }\n    }\n\n    private clearAll(): void {\n        this.annotations = [];\n        this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);\n    }\n\n    private drawAnnotation(annotation: Annotation): void {\n        const { startX, startY, endX, endY } = annotation;\n\n        // general variables useful for drawing annotations\n        const squareSize = this.ctx.canvas.width / 8;\n        const halfSquare = this.ctx.canvas.width / 16;\n\n        // start and end coordinates in pixel coordinates\n        const sx = startX * squareSize + halfSquare;\n        const sy = startY * squareSize + halfSquare;\n        const ex = endX   * squareSize + halfSquare;\n        const ey = endY   * squareSize + halfSquare;\n\n        // representing as a vector\n        const x = endX - startX;\n        const y = endY - startY;\n        const mag = Math.sqrt(x**2 + y**2);\n        const nx = x / mag;\n        const ny = y / mag;\n\n        // rotated by 90 degrees\n        const rx = -ny;\n        const ry = nx;\n\n        if (sx == ex && sy == ey){\n            // draw just a highlight on the square\n            this.ctx.lineWidth = 12;\n            this.ctx.beginPath();\n            this.ctx.arc(sx, sy, halfSquare - this.ctx.lineWidth / 2, 0, 2 * Math.PI);\n            this.ctx.stroke();\n        }else{\n\n            const midOffsetX = -50 * nx;\n            const midOffsetY = -50 * ny;\n            const arrowOffsetX = -80 * nx;\n            const arrowOffsetY = -80 * ny;\n\n            // otherwise let's draw an arrow from start to end\n            this.ctx.lineWidth = 25;\n            this.ctx.beginPath();\n            this.ctx.moveTo(sx, sy);\n            this.ctx.lineTo(ex + midOffsetX, ey + midOffsetY);\n            this.ctx.stroke();\n\n            this.ctx.lineWidth = 0;\n            this.ctx.beginPath();\n            this.ctx.moveTo(ex, ey);\n\n            this.ctx.lineTo(ex + 50 * rx + arrowOffsetX, ey + 50 * ry + arrowOffsetY);\n            this.ctx.lineTo(ex - 50 * rx + arrowOffsetX, ey - 50 * ry + arrowOffsetY);\n\n            this.ctx.lineTo(ex, ey);\n            this.ctx.fill();\n        }\n    }\n\n    private mousedown(event: MouseEvent): void {\n        if (event.button != 2)\n            return;\n\n        const rect = this.ctx.canvas.getBoundingClientRect();\n\n        this.startX = Math.floor((event.clientX - rect.x) / this.ctx.canvas.clientWidth * 8);\n        this.startY = Math.floor((event.clientY - rect.y) / this.ctx.canvas.clientHeight * 8);\n\n        // if board is flipped, flip the coords too\n        if (this.boardgfx.isFlipped){\n            this.startX = 7 - this.startX;\n            this.startY = 7 - this.startY;\n        }\n    }\n\n    private mouseup(event: MouseEvent): void {\n        if (event.button != 2)\n            return this.clearAll();\n        if (!this.startX || !this.startY)\n            return;\n    \n        const rect = this.ctx.canvas.getBoundingClientRect();\n    \n        let annotationEndX = Math.floor((event.clientX - rect.x) / this.ctx.canvas.clientWidth * 8);\n        let annotationEndY = Math.floor((event.clientY - rect.y) / this.ctx.canvas.clientHeight * 8);\n    \n        // flip coords if board flipped too\n        if (this.boardgfx.isFlipped){\n            annotationEndX = 7 - annotationEndX;\n            annotationEndY = 7 - annotationEndY;\n        }\n    \n        const annotation = this.getAnnotation(this.startX, this.startY, annotationEndX, annotationEndY);\n        if (annotation){\n            const index = this.annotations.indexOf(annotation);\n            this.annotations.splice(index, 1);\n            this.redrawAll();\n        }else{\n            const a = {\n                startX: this.startX,\n                startY: this.startY,\n                endX: annotationEndX,\n                endY: annotationEndY\n            };\n            this.drawAnnotation(a);\n            this.annotations.push(a);\n        }\n\n        event.preventDefault();\n    }\n\n    private getAnnotation(startX: number, startY: number, endX: number, endY: number): Annotation | undefined {\n        for (const a of this.annotations){\n            if (a.startX == startX && a.startY == startY && a.endX == endX && a.endY == endY)\n                return a;\n        }\n        return undefined;\n    }\n}\n"]}