{"version":3,"file":"input.js","sourceRoot":"","sources":["../../graphics/input.ts"],"names":[],"mappings":"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","sourcesContent":["import { setAllMoveHighlightsToPool, getMoveHighlightFromPool } from \"./pool.js\";\nimport type { BoardGraphics } from \"./board-graphics.js\";\nimport { Move } from \"../game/move.js\";\n\n// This file handles the way that the user might interact with the game board via dragging pieces.\n\ninterface Input {\n    currentMoves: Move[],\n    selected?: HTMLElement,\n    draggingElem?: HTMLElement,\n    gameState?: BoardGraphics,\n    testMove?: Move,\n    dragging?: HTMLElement\n};\n\n// make pieces draggable\nconst INPUT: Input = {\n    currentMoves: []\n};\n\nexport function initInput(): void {\n    document.body.addEventListener(\"pointerup\", draggingPointerup);\n    document.body.addEventListener(\"pointermove\", pointerMove);\n    document.body.addEventListener(\"touchmove\", touchMove, { passive: false });\n}\n\nexport function setInputTarget(gameState: BoardGraphics, draggingElem: HTMLElement, event: PointerEvent): void {\n    INPUT.gameState = gameState;\n    INPUT.draggingElem = draggingElem;\n\n    piecePointerdown(event);\n}\n\n// sets the elements dragging position based on the user's pointer position\nfunction setDraggingElemPos(pageX: number, pageY: number): void {\n    if (!INPUT.dragging)\n        return;\n    if (INPUT.draggingElem){\n        INPUT.draggingElem.style.left = `calc(${pageX}px - var(--piece-width) / 2)`;\n        INPUT.draggingElem.style.top = `calc(${pageY}px - var(--piece-height) / 2)`;\n    }\n}\n\nfunction pointerMove(event: PointerEvent): void {\n    if (INPUT.dragging)\n        event.preventDefault();\n    setDraggingElemPos(event.pageX, event.pageY);\n}\n\n// prevent scrolling and glitches on mobile devices when thing is being dragged\nfunction touchMove(event: TouchEvent): void {\n    if (INPUT.dragging)\n        event.preventDefault();\n}\n\nfunction piecePointerdown(event: PointerEvent): void {\n    const elem = event.target as HTMLElement;\n    if (event.button !== undefined && event.button != 0)\n        return;\n\n    if (!elem.classList.contains(\"board-graphics__move-highlight\"))\n        setAllMoveHighlightsToPool(INPUT.gameState!.skeleton);\n    else\n        return draggingPointerup(event);\n\n    if (!elem.dataset[\"coords\"])\n        return;\n\n    const coords = elem.dataset[\"coords\"].split(\"_\");\n    const square = parseInt(coords[0]!) + parseInt(coords[1]!) * 8;\n\n    // check with gameState if the piece can move\n    if (!INPUT.gameState!.canMove(square))\n        return;\n\n    const piece = INPUT.gameState!.getPiece(square);\n\n    INPUT.dragging = elem;\n    INPUT.selected = elem;\n    elem.classList.add(\"board-graphics__piece--dragged\");\n    if (INPUT.draggingElem){\n        // copy over graphics\n        INPUT.draggingElem.style.backgroundPositionY = INPUT.dragging.style.backgroundPositionY;\n        INPUT.draggingElem.className = \"board-graphics__dragging\";\n        INPUT.draggingElem.classList.add(`board-graphics__piece--type-${INPUT.dragging.dataset[\"pieceType\"]}`);\n        INPUT.draggingElem.style.display = \"block\";\n    }\n\n    setDraggingElemPos(event.pageX, event.pageY);\n\n    // get moves for selected piece and display them\n    INPUT.currentMoves = INPUT.gameState!.generatePieceMoves(square, piece);\n    for (let i = 0; i < INPUT.currentMoves.length; i++){\n        const move = INPUT.currentMoves[i]!;\n        \n        const highlight = getMoveHighlightFromPool(move.to % 8, Math.floor(move.to / 8), INPUT.gameState!.isFlipped);\n        highlight.dataset[\"index\"] = i.toString();\n\n        // if move is a capture, update highlight graphically to indicate that\n        if (move.captures.length > 0)\n            highlight.classList.add(\"board-graphics__move-highlight--capture\");\n\n        INPUT.gameState!.piecesDiv.appendChild(highlight);\n    }\n}\n\nfunction draggingPointerup(event: PointerEvent): void {\n    if (event.button == 2)\n        return;\n\n    if (INPUT.dragging){\n        INPUT.dragging.classList.remove(\"board-graphics__piece--dragged\");\n        INPUT.draggingElem!.style.display = \"none\";\n    }\n    \n    let highlight = event.target as HTMLElement;\n\n    // handle touch events\n    if (event.pointerType == \"touch\")\n        highlight = document.elementFromPoint(event.clientX, event.clientY) as HTMLElement;\n    \n    // player let go at a highlight, indicating they're moving the piece there.\n    if (highlight.classList.contains(\"board-graphics__move-highlight\")){\n        INPUT.testMove = INPUT.currentMoves[parseInt(highlight.dataset[\"index\"]!)]!;\n\n        // testMove handlers\n        INPUT.gameState!.playMove(INPUT.testMove);\n        INPUT.gameState!.applyChanges(true);\n        delete INPUT.testMove;\n\n        // clear all moves from board\n        setAllMoveHighlightsToPool(INPUT.gameState!.skeleton);\n    }\n\n    if (!INPUT.dragging){\n        // clear all moves from board\n        if (INPUT.gameState)\n            setAllMoveHighlightsToPool(INPUT.gameState.skeleton);\n    }else{\n        delete INPUT.dragging;\n    }\n}\n"]}