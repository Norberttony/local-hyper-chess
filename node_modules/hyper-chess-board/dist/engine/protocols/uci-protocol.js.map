{"version":3,"file":"uci-protocol.js","sourceRoot":"","sources":["../../../engine/protocols/uci-protocol.ts"],"names":[],"mappings":"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","sourcesContent":["import { BotProtocol } from \"../abstract/protocol.js\";\nimport { StartingFEN } from \"../../game/board.js\";\nimport { readWords } from \"./utils.js\";\nimport type { BotProcess } from \"../abstract/bot-process.js\";\nimport { GameTime, Score } from \"../utils.js\";\n\nexport class UCIBotProtocol extends BotProtocol {\n    private startFEN: string = \"\";\n    private moves: string[] = [];\n\n    constructor(botProcess: BotProcess){\n        super(botProcess);\n        this.setFEN(StartingFEN);\n        botProcess.addReadLineListener(line => this.#readThinkStats(line));\n    }\n\n    #readThinkStats(line: string): void {\n        const words = readWords(line);\n        if (line.startsWith(\"info\")){\n            this.updateThinkStats({\n                depth: parseInt(extractInfo(line, \"depth\")),\n                score: extractScore(line),\n                nodes: parseInt(extractInfo(line, \"nodes\")),\n                time:  parseInt(extractInfo(line, \"time\")),\n                pv: extractPV(line)\n            });\n        }else if (line.startsWith(\"bestmove\")){\n            this.updateThinkStats({ bestmove: words[1]! });\n        }else if (line.startsWith(\"id\")){\n            if (words[1] == \"name\"){\n                words.splice(0, 2);\n                this.setEngineName(words.join(\" \"));\n            }else if (words[1] == \"author\"){\n                words.splice(0, 2);\n                this.setAuthorName(words.join(\" \"));\n            }\n        }\n    }\n\n    public setFEN(fen: string): void {\n        this.startFEN = fen;\n        this.bot.write(`position fen ${fen}`);\n    }\n\n    public playMove(lan: string): void {\n        this.moves.push(lan);\n        this.bot.write(`position fen ${this.startFEN} moves ${this.moves.join(\" \")}`);\n    }\n\n    public override async thinkForMoveTime(ms: number , allowTimeout = false, timeoutPaddingMs = 500): Promise<string | undefined> {\n        let timeoutMs: number | undefined = undefined;\n        if (allowTimeout)\n            timeoutMs = ms + timeoutPaddingMs;\n        await this.bot.prompt(`go movetime ${ms}`, \"bestmove\", timeoutMs);\n        return this.getThinkStats().bestmove;\n    }\n\n    public override async thinkTimedGame(time: GameTime, allowTimeout = false, isWhite = false, timeoutPaddingMs = 500): Promise<string | undefined> {\n        let timeoutMs: number | undefined = undefined;\n        if (allowTimeout)\n            timeoutMs = (isWhite ? time.wtime : time.btime) + timeoutPaddingMs;\n        await this.bot.prompt(`go wtime ${time.wtime} btime ${time.btime} winc ${time.winc} binc ${time.binc}`, \"bestmove\", timeoutMs);\n        return this.getThinkStats().bestmove;\n    }\n\n    public override async thinkForDepth(depth: number): Promise<string | undefined> {\n        await this.bot.prompt(`go depth ${depth}`, \"bestmove\");\n        return this.getThinkStats().bestmove;\n    }\n\n    public override startThink(): void {\n        this.bot.write(\"go\");\n    }\n\n    public override stopThink(): void {\n        this.bot.write(\"stop\");\n    }\n\n    public override async isReady(timeoutMs: number = 1000): Promise<boolean> {\n        try {\n            await this.bot.prompt(`uciready`, `uciok`, timeoutMs);\n        }\n        catch(err){\n            return false;\n        }\n        return true;\n    }\n}\n\n// to-do: this function assumes that the info line is formatted without any\n// unnecessary spaces between the words. This should be fixed to allow for\n// such spaces\nfunction extractInfo(line: string, name: string): string {\n    const idx = line.indexOf(` ${name} `);\n    if (idx == -1)\n        return \"\";\n\n    const leftSpace = idx + 1 + name.length;\n    const rightSpace = line.indexOf(\" \", leftSpace + 1);\n    return line.substring(leftSpace + 1, rightSpace);\n}\n\nfunction extractPV(line: string): string {\n    const idx = line.indexOf(\" pv \");\n    return line.substring(idx + 4).trim();\n}\n\nfunction extractScore(line: string): Score | undefined {\n    const mateScore = parseInt(extractInfo(line, \"score mate\"));\n    const cpScore = parseInt(extractInfo(line, \"score cp\"));\n    if (mateScore)\n        return { value: mateScore, isMate: true };\n    else if (cpScore)\n        return { value: cpScore, isMate: false };\n    else\n        return undefined;\n}\n"]}