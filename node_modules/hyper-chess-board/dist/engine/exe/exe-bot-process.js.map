{"version":3,"file":"exe-bot-process.js","sourceRoot":"","sources":["../../../engine/exe/exe-bot-process.ts"],"names":[],"mappings":"AAAA,OAAO,EAAkC,KAAK,EAAE,MAAM,oBAAoB,CAAC;AAC3E,OAAO,EAAE,UAAU,EAAE,MAAM,4BAA4B,CAAC;AAExD,MAAM,OAAO,aAAc,SAAQ,UAAU;IAItB;IAHX,MAAM,GAAW,EAAE,CAAC;IACpB,IAAI,CAAkC;IAE9C,YAAmB,IAAY;QAC3B,KAAK,EAAE,CAAC;QADO,SAAI,GAAJ,IAAI,CAAQ;QAE3B,IAAI,CAAC,KAAK,EAAE,CAAC;IACjB,CAAC;IAED,IAAoB,SAAS;QACzB,IAAI,CAAC,IAAI,CAAC,IAAI;YACV,OAAO,KAAK,CAAC;;YAEb,OAAO,IAAI,CAAC,IAAI,CAAC,QAAQ,KAAK,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,UAAU,KAAK,IAAI,CAAC;IAC5E,CAAC;IAED,mEAAmE;IACnE,SAAS,CAAC,UAAkB;QACxB,6EAA6E;QAC7E,MAAM,KAAK,GAAG,CAAC,IAAI,CAAC,MAAM,GAAG,UAAU,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;QACvD,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,IAAI,EAAE;YAC7D,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,GAAG,EAAG,CAAC;QAE/B,KAAK,MAAM,CAAC,IAAI,KAAK;YACjB,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;IACzB,CAAC;IAEe,KAAK;QACjB,IAAI,CAAC,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAE7B,uDAAuD;QACvD,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QAEjB,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,EAAE;YACjC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;QACpC,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,GAAU,EAAE,EAAE;YACjC,MAAM,GAAG,CAAC;QACd,CAAC,CAAC,CAAC;IACP,CAAC;IAED,gEAAgE;IAChE,0BAA0B;IACV,IAAI;QAChB,IAAI,IAAI,CAAC,IAAI,EAAC,CAAC;YACX,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;YACjB,OAAO,IAAI,CAAC,IAAI,CAAC;QACrB,CAAC;IACL,CAAC;IAED,8BAA8B;IAC9B,8CAA8C;IAC9C,iDAAiD;IACjC,KAAK,CAAC,GAAW;QAC7B,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACjB,IAAI,IAAI,CAAC,IAAI;YACT,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC;;YAElC,MAAM,IAAI,KAAK,CAAC,0EAA0E,CAAC,CAAC;IACpG,CAAC;CACJ","sourcesContent":["import { ChildProcessWithoutNullStreams, spawn } from \"node:child_process\";\nimport { BotProcess } from \"../abstract/bot-process.js\";\n\nexport class ExeBotProcess extends BotProcess {\n    private broken: string = \"\";\n    private proc?: ChildProcessWithoutNullStreams;\n\n    constructor(public path: string){\n        super();\n        this.start();\n    }\n\n    public override get isRunning(): boolean {\n        if (!this.proc)\n            return false;\n        else\n            return this.proc.exitCode === null && this.proc.signalCode === null;\n    }\n    \n    // internal function that separates out stdout into complete lines.\n    #getLines(stdoutData: string): void {\n        // stdout data might have multiple lines, and the last line might be cut off.\n        const lines = (this.broken + stdoutData).split(\"\\r\\n\");\n        if (!stdoutData.endsWith(\"\\r\\n\") || lines[lines.length - 1] == \"\")\n            this.broken = lines.pop()!;\n\n        for (const l of lines)\n            this.readLine(l);\n    }\n\n    public override start(): void {\n        this.proc = spawn(this.path);\n\n        // broken keeps track of \"broken\" lines (see #getLines)\n        this.broken = \"\";\n\n        this.proc.stdout.on(\"data\", (data) => {\n            this.#getLines(data.toString());\n        });\n\n        this.proc.on(\"error\", (err: Error) => {\n            throw err;\n        });\n    }\n\n    // kills the process. Must be run when done interacting with the\n    // ExeBotProcess instance.\n    public override stop(): void {\n        if (this.proc){\n            this.proc.kill();\n            delete this.proc;\n        }\n    }\n\n    // returns nothing, can error.\n    // feeds the command cmd as the engine's input\n    // errors if the process is not currently running\n    public override write(cmd: string): void {\n        super.write(cmd);\n        if (this.proc)\n            this.proc.stdin.write(`${cmd}\\n`);\n        else\n            throw new Error(\"ExeBotProcess: cannot .write(cmd) when the engine process is not running\");\n    }\n}\n"]}